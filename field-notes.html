<!doctype html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Field Notes | The Dreaming Tower Archives</title>

  <meta name="description" content="Recovered field notes from the Dreaming Tower archives. Aera's logs, Lorekeeper notes, and real-world resonance." />
  <meta name="keywords" content="cyber lorekeeper, field notes, cybersecurity storytelling, fantasy cyberpunk, dreaming tower" />

  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="shortcut icon" href="/images/favicon.ico">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Source+Sans+3:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Global Styles -->
  <link rel="stylesheet" href="/css/styles.css" />
</head>

<body class="bg-deep-space text-stardust font-body selection:bg-glow/20 selection:text-stardust">
  <main class="relative min-h-screen">
    <img src="/images/background-1.png" alt="" class="absolute inset-0 h-full w-full object-cover" />
    <div class="absolute inset-0 bg-gradient-to-br from-deep-space/70 via-abyss/80 to-deep-space/85"></div>
    
  <!-- Header inject -->
  <div id="site-header"></div>

    <!-- Hero -->
    <section class="relative mx-auto max-w-6xl px-6 pt-10 pb-6">
      <p class="uppercase tracking-[.18em] text-stardust/70 text-xs">
        Dreaming Tower Archives
      </p>
      <h1 class="mt-2 font-display text-4xl sm:text-5xl leading-tight text-gradient">
        Field Notes
      </h1>
      <p class="mt-4 max-w-3xl text-stardust/85">
        Recovered entries from the Tower's margins. Some are personal logs. Some are warnings. Some are 
        reflections that echo into our world.
      </p>
    </section>>

    <!-- Featured Section -->
    <section class="relative mx-auto max-w-6xl px-6 pb-6">
      <div class="flex items-center justify-between gap-4 flex-wrap">
        <div>
          <p class="uppercase tracking-[.18em] text-stardust/70 text-xs">Featured</p>
          <h2 class="font-display text-3xl text-stardust">Highlighted Field Notes</h2>
        </div>
        <a href="#archive" class="text-sm font-semibold text-glow hover:underline underline-offset-4">View All Entries →</a>
      </div>

      <!-- Featured entries grid - balanced 3-column layout -->
      <div id="featuredEntries" class="mt-6 grid gap-6 md:grid-cols-2 lg:grid-cols-3"></div>
    </section>

    <!-- Filters -->
    <section class="relative mx-auto max-w-6xl px-6 pt-6 pb-4">
      <div class="soft-card p-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <!-- Filter buttons will be dynamically generated based on available categories -->
        <div id="filterButtons" class="flex flex-wrap gap-2 text-sm"></div>

        <div class="flex flex-wrap gap-3 items-center text-sm text-stardust/80">
          <label for="sortOrder" class="sr-only">Sort entries</label>
          <select id="sortOrder" class="focus-ring rounded-md border border-rift/60 bg-abyss/60 px-3 py-2 text-stardust/90">
            <option value="newest">By Date (Newest)</option>
            <option value="oldest">By Date (Oldest)</option>
          </select>

          <div class="relative">
            <label for="search" class="sr-only">Search</label>
            <input id="search" type="search" placeholder="Search..."
                   class="focus-ring rounded-md border border-rift/60 bg-abyss/60 px-10 py-2 text-sm placeholder:text-stardust/50 text-stardust w-56" />
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-xs text-stardust/50">⌕</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Archive -->
    <section id="archive" class="relative mx-auto max-w-6xl px-6 pb-12">
      <div class="soft-card p-6">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <div>
            <p class="uppercase tracking-[.18em] text-stardust/70 text-xs">Archive</p>
            <h2 class="font-display text-3xl text-stardust">All Field Notes</h2>
          </div>
          <p class="text-sm text-stardust/70">Browse, filter, and trace the patterns.</p>
        </div>

        <ul id="archiveList" class="mt-6 space-y-4"></ul>
      </div>
    </section>

  <!-- Footer inject -->
  <div id="site-footer"></div>
  </main>

  <!-- Partials loader -->
  <script>
    async function loadPartial(targetId, url) {
      const el = document.getElementById(targetId);
      if (!el) return;

      try {
        const res = await fetch(url, { cache: "no-cache" });
        if (!res.ok) {
          console.warn(`Failed to load ${url}: ${res.status}`);
          return;
        }
        el.innerHTML = await res.text();
      } catch (err) {
        console.warn(`Error loading ${url}`, err);
      }
    }

    function initHeaderNav() {
      const navToggle = document.getElementById("navToggle");
      const mobileNavPanel = document.getElementById("mobileNavPanel");
      if (!navToggle || !mobileNavPanel) return;

      navToggle.addEventListener("click", () => {
        const isOpen = navToggle.getAttribute("aria-expanded") === "true";
        navToggle.setAttribute("aria-expanded", String(!isOpen));
        mobileNavPanel.classList.toggle("hidden", isOpen);
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          navToggle.setAttribute("aria-expanded", "false");
          mobileNavPanel.classList.add("hidden");
        }
      });
    }

    function initFooterYear() {
      const footerYear = document.querySelector('#site-footer #year');
      if (footerYear) footerYear.textContent = new Date().getFullYear();
    }

    (async function boot() {
      await loadPartial("site-header", "/partials/header.html");
      initHeaderNav();

      await loadPartial("site-footer", "/partials/footer.html");
      initFooterYear();
    })();
  </script>

  <!-- Field Notes: JSON-powered renderer -->
  <script>
    (() => {
      const INDEX_URL = "/data/field-notes.index.json";
      const MAX_FEATURED = 3; // Limit featured entries to 3

      // Filter button configuration - only shown if category has released entries
      const filterConfig = {
        all: { label: "All Entries", alwaysShow: true },
        aera: { label: "Aera's Logs" },
        lore: { label: "Lorekeeper's Notes" },
        resonance: { label: "Real-World Resonance" },
      };

      const badgeMap = {
        aera: { label: "Aera's Logs", className: "badge badge-aera" },
        lore: { label: "Lorekeeper's Notes", className: "badge badge-lore" },
        resonance: { label: "Real-World Resonance", className: "badge badge-resonance" },
      };

      const els = {
        featured: document.getElementById("featuredEntries"),
        archive: document.getElementById("archiveList"),
        filterContainer: document.getElementById("filterButtons"),
        sort: document.getElementById("sortOrder"),
        search: document.getElementById("search"),
      };

      if (!els.featured || !els.archive) {
        console.warn("Field Notes: missing one or more required containers (#featuredEntries, #archiveList).");
        return;
      }

      let allEntries = [];
      let activeFilter = "all";
      let sortOrder = els.sort?.value || "newest";
      let query = "";

      const normalize = (s) => (s || "").toString().toLowerCase().trim();

      function parseDateISO(dateStr) {
        const d = new Date(dateStr);
        return Number.isNaN(d.getTime()) ? null : d;
      }

      function formatDate(dateStr) {
        const d = parseDateISO(dateStr);
        if (!d) return dateStr || "";
        return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
      }

      // Build filter buttons dynamically based on what categories have entries
      function buildFilterButtons() {
        if (!els.filterContainer) return;
        
        els.filterContainer.innerHTML = "";
        
        // Get unique categories from released entries
        const availableCategories = new Set(allEntries.map(e => e.category));
        
        // Create buttons for each filter
        Object.entries(filterConfig).forEach(([key, config]) => {
          // Skip category filters that have no released entries (unless alwaysShow)
          if (!config.alwaysShow && !availableCategories.has(key)) return;
          
          const btn = document.createElement("button");
          btn.className = "filter-btn focus-ring rounded-md border border-rift/60 bg-abyss/50 px-3 py-2 font-semibold text-stardust/85 hover:text-glow";
          btn.setAttribute("data-filter", key);
          btn.textContent = config.label;
          
          btn.addEventListener("click", () => {
            activeFilter = key;
            update();
          });
          
          els.filterContainer.appendChild(btn);
        });
      }

      function highlightActiveFilter() {
        const filterBtns = Array.from(document.querySelectorAll("[data-filter]"));
        filterBtns.forEach((btn) => {
          const isActive = (btn.getAttribute("data-filter") || "all") === activeFilter;
          btn.classList.toggle("is-active", isActive);
          btn.setAttribute("aria-pressed", String(isActive));
        });
      }

      function escapeHtml(str) {
        const div = document.createElement("div");
        div.textContent = str || "";
        return div.innerHTML;
      }

      function escapeAttr(str) {
        return (str || "").replace(/"/g, "&quot;");
      }

      function matchesFilters(entry) {
        if (activeFilter !== "all" && entry.category !== activeFilter) return false;
        if (!query) return true;

        const haystack = normalize(
          [entry.title, entry.subtitle, entry.excerpt, ...entry.tags].join(" ")
        );
        return haystack.includes(query);
      }

      function sortEntries(list) {
        return [...list].sort((a, b) => {
          const da = parseDateISO(a.date);
          const db = parseDateISO(b.date);
          if (!da && !db) return 0;
          if (!da) return 1;
          if (!db) return -1;
          return sortOrder === "oldest" ? da - db : db - da;
        });
      }

      // Render featured entries - limited to MAX_FEATURED, only entries with featured: true
      function renderFeatured(allSortedEntries) {
        els.featured.innerHTML = "";
        
        // Get only entries marked as featured, limited to MAX_FEATURED
        const featuredEntries = allSortedEntries
          .filter((e) => e.featured)
          .slice(0, MAX_FEATURED);
        
        if (featuredEntries.length === 0) {
          // If no featured entries, hide the section or show a message
          els.featured.innerHTML = `
            <p class="text-stardust/60 text-sm col-span-full">No featured entries at this time.</p>
          `;
          return;
        }

        featuredEntries.forEach((entry) => {
          const badge = badgeMap[entry.category] || { label: "Field Note", className: "badge" };
          const card = document.createElement("article");
          card.className = "soft-card p-5 flex flex-col gap-3";
          card.innerHTML = `
            <div class="flex items-start justify-between gap-3 flex-wrap">
              <div class="${badge.className}">${escapeHtml(badge.label)}</div>
              <p class="text-xs text-stardust/65">
                ${escapeHtml(formatDate(entry.date))}${entry.readTime ? ` • ${entry.readTime} min read` : ""}
              </p>
            </div>

            <h3 class="font-display text-xl text-stardust">
              <a href="${escapeAttr(entry.href)}" class="hover:text-glow">${escapeHtml(entry.title)}</a>
            </h3>

            ${entry.subtitle ? `<p class="text-sm text-stardust/75">${escapeHtml(entry.subtitle)}</p>` : ""}

            ${entry.excerpt ? `<p class="text-sm text-stardust/85 leading-relaxed line-clamp-3">${escapeHtml(entry.excerpt)}</p>` : ""}

            <div class="mt-auto pt-2 flex flex-wrap gap-3 items-center justify-between">
              <a class="focus-ring inline-flex items-center gap-2 font-semibold text-stardust/90 hover:text-glow" href="${escapeAttr(entry.href)}">
                Read More →
              </a>
              <button class="focus-ring inline-flex items-center gap-2 font-semibold text-stardust/80 hover:text-glow text-sm" type="button" data-share="${escapeAttr(entry.href)}">
                Share
              </button>
            </div>
          `;
          els.featured.appendChild(card);
        });
      }

      function renderArchive(list) {
        els.archive.innerHTML = "";
        
        if (list.length === 0) {
          els.archive.innerHTML = `
            <li class="text-stardust/60 text-sm">No entries match your current filters.</li>
          `;
          return;
        }
        
        list.forEach((entry) => {
          const badge = badgeMap[entry.category] || { label: "Field Note", className: "badge" };
          const li = document.createElement("li");
          li.className = "rounded-xl border border-rift/70 bg-abyss/40 backdrop-blur-sm p-5";
          li.innerHTML = `
            <div class="flex items-start justify-between gap-4 flex-wrap">
              <div class="${badge.className}">${escapeHtml(badge.label)}</div>
              <p class="text-xs text-stardust/65">
                ${escapeHtml(formatDate(entry.date))}${entry.readTime ? ` • ${entry.readTime} min read` : ""}
              </p>
            </div>

            <h3 class="mt-3 font-display text-xl text-stardust">
              <a href="${escapeAttr(entry.href)}" class="hover:text-glow">${escapeHtml(entry.title)}</a>
            </h3>

            ${entry.subtitle ? `<p class="mt-2 text-sm text-stardust/75">${escapeHtml(entry.subtitle)}</p>` : ""}

            ${entry.excerpt ? `<p class="mt-3 text-sm text-stardust/85 leading-relaxed">${escapeHtml(entry.excerpt)}</p>` : ""}

            <div class="mt-4 flex flex-wrap gap-3 items-center justify-between">
              <a class="focus-ring inline-flex items-center gap-2 font-semibold text-stardust/90 hover:text-glow" href="${escapeAttr(entry.href)}">
                Read More →
              </a>
              <button class="focus-ring inline-flex items-center gap-2 font-semibold text-stardust/80 hover:text-glow" type="button" data-share="${escapeAttr(entry.href)}">
                Share This Entry
              </button>
            </div>
          `;
          els.archive.appendChild(li);
        });
      }

      function update() {
        const filtered = allEntries.filter(matchesFilters);
        const sorted = sortEntries(filtered);

        renderFeatured(sorted);
        renderArchive(sorted);
        highlightActiveFilter();
      }

      if (els.sort) {
        els.sort.addEventListener("change", (e) => {
          sortOrder = e.target.value || "newest";
          update();
        });
      }

      if (els.search) {
        els.search.addEventListener("input", (e) => {
          query = normalize(e.target.value);
          update();
        });
      }

      document.addEventListener("click", async (e) => {
        const btn = e.target.closest("[data-share]");
        if (!btn) return;

        const href = btn.getAttribute("data-share") || "";
        const url = new URL(href, window.location.origin).toString();

        try {
          if (navigator.share) {
            await navigator.share({ title: document.title, url });
          } else {
            await navigator.clipboard.writeText(url);
            const original = btn.textContent;
            btn.textContent = "Copied!";
            setTimeout(() => (btn.textContent = original), 1200);
          }
        } catch (_) {
          // ignore user cancel
        }
      });

      async function loadIndex() {
        try {
          const res = await fetch(INDEX_URL, { cache: "no-cache" });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          if (!Array.isArray(data)) throw new Error("Index JSON is not an array.");

          // FILTER: Only include entries where released: true
          allEntries = data
            .filter((n) => n && n.id && n.title && n.category && n.href && n.released === true)
            .map((n) => ({
              id: n.id,
              category: n.category,
              title: n.title,
              subtitle: n.subtitle || "",
              date: n.date || "",
              readTime: typeof n.readTime === "number" ? n.readTime : null,
              excerpt: n.excerpt || "",
              featured: !!n.featured,
              href: n.href,
              tags: Array.isArray(n.tags) ? n.tags : [],
            }));

          // Build filter buttons based on available categories
          buildFilterButtons();
          update();
        } catch (err) {
          console.warn("Field Notes: failed to load index JSON", err);

          els.featured.innerHTML = `
            <div class="soft-card p-6 col-span-full">
              <p class="text-stardust/80">
                Could not load Field Notes right now. Check that
                <code class="text-stardust">/data/field-notes.index.json</code>
                exists and is accessible.
              </p>
            </div>
          `;
          els.archive.innerHTML = "";
        }
      }

      loadIndex();
    })();
  </script>
</body>
</html>
