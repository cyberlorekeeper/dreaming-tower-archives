name: Publish Approved Field Note

on:
  push:
    paths:
      - '_queue/pending-field-note.json'
    branches:
      - main

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Read and process pending field note
        id: process
        run: |
          # Read the pending file
          CONTENT=$(cat _queue/pending-field-note.json)
          
          # Decode if base64 (GitHub stores as base64)
          if echo "$CONTENT" | jq -e . >/dev/null 2>&1; then
            DATA="$CONTENT"
          else
            DATA=$(echo "$CONTENT" | base64 -d)
          fi
          
          # Extract fields
          NOTE_ID=$(echo "$DATA" | jq -r '.noteId')
          FILENAME=$(echo "$DATA" | jq -r '.filename')
          DATE=$(echo "$DATA" | jq -r '.date')
          TITLE=$(echo "$DATA" | jq -r '.field_note.title')
          SUBTITLE=$(echo "$DATA" | jq -r '.field_note.subtitle')
          EXCERPT=$(echo "$DATA" | jq -r '.field_note.excerpt')
          READ_TIME=$(echo "$DATA" | jq -r '.field_note.readTime')
          EPIGRAPH=$(echo "$DATA" | jq -r '.field_note.epigraph')
          SLUG=$(echo "$DATA" | jq -r '.field_note.slug')
          ORIGINAL_URL=$(echo "$DATA" | jq -r '.originalUrl')
          
          # Save to environment
          echo "NOTE_ID=$NOTE_ID" >> $GITHUB_OUTPUT
          echo "FILENAME=$FILENAME" >> $GITHUB_OUTPUT
          echo "DATE=$DATE" >> $GITHUB_OUTPUT
          echo "TITLE=$TITLE" >> $GITHUB_OUTPUT
          echo "SUBTITLE=$SUBTITLE" >> $GITHUB_OUTPUT
          echo "EXCERPT=$EXCERPT" >> $GITHUB_OUTPUT
          echo "READ_TIME=$READ_TIME" >> $GITHUB_OUTPUT
          echo "SLUG=$SLUG" >> $GITHUB_OUTPUT
          echo "ORIGINAL_URL=$ORIGINAL_URL" >> $GITHUB_OUTPUT
          
          # Save full data for later steps
          echo "$DATA" > /tmp/field-note-data.json
      
      - name: Generate HTML file
        env:
          FILENAME: ${{ steps.process.outputs.FILENAME }}
        run: |
          node > /tmp/generate-html.log 2>&1 << 'ENDSCRIPT'
          const fs = require('fs');
          
          // Read the data
          const data = JSON.parse(fs.readFileSync('/tmp/field-note-data.json', 'utf8'));
          const fieldNote = data.field_note;
          
          // Build tags HTML
          const tagsHtml = fieldNote.tags
            .map(tag => '            <span class="field-note-tag">' + tag + '</span>')
            .join('\n');
          
          // Build body paragraphs HTML
          const bodyHtml = fieldNote.body_paragraphs
            .map(para => '                    <p>' + para + '</p>')
            .join('\n\n');
          
          // Format date
          const dateObj = new Date(data.date + 'T00:00:00');
          const displayDate = dateObj.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          });
          
          const html = '<!doctype html>\n' +
          '<html lang="en" class="scroll-smooth">\n' +
          '<head>\n' +
          '  <meta charset="utf-8" />\n' +
          '  <meta name="viewport" content="width=device-width, initial-scale=1" />\n' +
          '  \n' +
          '  <title>' + fieldNote.title + ' | Field Notes | The Dreaming Tower Archives</title>\n' +
          '  <meta name="description" content="' + fieldNote.subtitle + ' ‚Äî ' + fieldNote.excerpt + '" />\n' +
          '  \n' +
          '  <!-- Favicons -->\n' +
          '  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">\n' +
          '  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.png">\n' +
          '  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">\n' +
          '  <link rel="shortcut icon" href="/images/favicon.ico">\n' +
          '\n' +
          '  <!-- Fonts -->\n' +
          '  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">\n' +
          '  <link href="https://fonts.googleapis.com/css2?family=Alex+Brush&family=Cinzel:wght@400;500;600;700&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">\n' +
          '  \n' +
          '  <!-- Global Styles -->\n' +
          '  <link rel="stylesheet" href="/css/styles.css" />\n' +
          '</head>\n' +
          '\n' +
          '<body class="bg-deep-space text-stardust font-body min-h-screen selection:bg-glow/20 selection:text-stardust">\n' +
          '  \n' +
          '  <!-- Background -->\n' +
          '  <div class="fixed inset-0 -z-10">\n' +
          '    <img src="/images/background-1.png" alt="" class="absolute inset-0 h-full w-full object-cover opacity-40" aria-hidden="true" />\n' +
          '    <div class="absolute inset-0 bg-gradient-to-b from-deep-space/70 via-abyss/80 to-deep-space/95"></div>\n' +
          '  </div>\n' +
          '\n' +
          '  <!-- Header -->\n' +
          '  <div id="site-header"></div>\n' +
          '\n' +
          '  <main class="relative px-6 py-12 md:py-16">\n' +
          '    \n' +
          '    <!-- Field Note Container -->\n' +
          '    <article class="field-note-container" data-note-id="' + data.noteId + '">\n' +
          '      \n' +
          '      <!-- The Parchment Paper -->\n' +
          '      <div class="field-note-paper">\n' +
          '        \n' +
          '        <!-- Header Section -->\n' +
          '        <header class="field-note-header">\n' +
          '          \n' +
          '          <!-- Category Badge -->\n' +
          '          <span class="field-note-category field-note-category-resonance">\n' +
          '            <span aria-hidden="true">‚ö°</span>\n' +
          '            Resonance\n' +
          '          </span>\n' +
          '          \n' +
          '          <!-- Title & Subtitle -->\n' +
          '          <h1 class="field-note-title">' + fieldNote.title + '</h1>\n' +
          '          <p class="field-note-subtitle">' + fieldNote.subtitle + '</p>\n' +
          '          \n' +
          '          <!-- Metadata -->\n' +
          '          <div class="field-note-meta">\n' +
          '            <span class="field-note-meta-item">\n' +
          '              <span aria-hidden="true">üìÖ</span>\n' +
          '              ' + displayDate + '\n' +
          '            </span>\n' +
          '            <span class="field-note-meta-item">\n' +
          '              <span aria-hidden="true">‚è±</span>\n' +
          '              ' + fieldNote.readTime + ' min read\n' +
          '            </span>\n' +
          '            <span class="field-note-meta-item">\n' +
          '              <span aria-hidden="true">üîó</span>\n' +
          '              Based on real events\n' +
          '            </span>\n' +
          '          </div>\n' +
          '        </header>\n' +
          '        \n' +
          '        <!-- Body Content -->\n' +
          '        <div class="field-note-body prose-field-note">\n' +
          '          \n' +
          '          <!-- Opening Epigraph -->\n' +
          '          <p class="epigraph">\n' +
          '            "' + fieldNote.epigraph + '"\n' +
          '          </p>\n' +
          '          \n' +
          '          <!-- Main Content -->\n' +
          bodyHtml + '\n' +
          '\n' +
          '          <hr />\n' +
          '          \n' +
          '        </div>\n' +
          '\n' +
          '        <!-- Signature -->\n' +
          '        <p class="field-note-signature">‚Äî The Lorekeeper</p>\n' +
          '          \n' +
          '        <!-- External link -->\n' +
          '        <a href="' + data.originalUrl + '" class="field-note-external-link" target="_blank" rel="noopener">\n' +
          '          <span class="field-note-external-link-label">\n' +
          '            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n' +
          '              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>\n' +
          '              <polyline points="15 3 21 3 21 9"/>\n' +
          '              <line x1="10" y1="14" x2="21" y2="3"/>\n' +
          '            </svg>\n' +
          '            External Article\n' +
          '          </span>\n' +
          '          <span class="field-note-external-link-title">\n' +
          '            Read the full analysis\n' +
          '            <span class="field-note-external-link-domain">‚Üí Source</span>\n' +
          '          </span>\n' +
          '        </a>\n' +
          '        \n' +
          '        <!-- Tags -->\n' +
          '        <div class="field-note-tags">\n' +
          tagsHtml + '\n' +
          '        </div>\n' +
          '        \n' +
          '      </div>\n' +
          '      <!-- End Parchment Paper -->\n' +
          '      \n' +
          '      <!-- Navigation Between Notes -->\n' +
          '      <nav class="field-note-nav" aria-label="Field note navigation">\n' +
          '        <a href="/field-notes.html" class="field-note-nav-link">\n' +
          '          <span class="field-note-nav-label">‚Üê Back</span>\n' +
          '          <span class="field-note-nav-title">All Field Notes</span>\n' +
          '        </a>\n' +
          '\n' +
          '        <a id="nextNoteLink" href="#" class="field-note-nav-link" style="display: none; text-align: right;">\n' +
          '          <span class="field-note-nav-label">Next ‚Üí</span>\n' +
          '          <span id="nextNoteTitle" class="field-note-nav-title"></span>\n' +
          '        </a>\n' +
          '      </nav>\n' +
          '      \n' +
          '    </article>\n' +
          '    \n' +
          '    <!-- Footer -->\n' +
          '    <div id="site-footer"></div>\n' +
          '  </main>\n' +
          '\n' +
          '  <!-- Scripts -->\n' +
          '  <script>\n' +
          '  async function loadPartial(targetId, url) {\n' +
          '    const el = document.getElementById(targetId);\n' +
          '    if (!el) return;\n' +
          '    try {\n' +
          '      const res = await fetch(url, { cache: "no-cache" });\n' +
          '      if (!res.ok) return;\n' +
          '      el.innerHTML = await res.text();\n' +
          '    } catch (err) {\n' +
          '      console.warn("Error loading " + url, err);\n' +
          '    }\n' +
          '  }\n' +
          '\n' +
          '  function initHeaderNav() {\n' +
          '    const navToggle = document.getElementById("navToggle");\n' +
          '    const mobileNavPanel = document.getElementById("mobileNavPanel");\n' +
          '    if (!navToggle || !mobileNavPanel) return;\n' +
          '\n' +
          '    navToggle.addEventListener("click", () => {\n' +
          '      const isOpen = navToggle.getAttribute("aria-expanded") === "true";\n' +
          '      navToggle.setAttribute("aria-expanded", String(!isOpen));\n' +
          '      mobileNavPanel.classList.toggle("hidden", isOpen);\n' +
          '    });\n' +
          '\n' +
          '    document.addEventListener("keydown", (e) => {\n' +
          '      if (e.key === "Escape") {\n' +
          '        navToggle.setAttribute("aria-expanded", "false");\n' +
          '        mobileNavPanel.classList.add("hidden");\n' +
          '      }\n' +
          '    });\n' +
          '  }\n' +
          '\n' +
          '  async function initDynamicNav() {\n' +
          '    const article = document.querySelector("[data-note-id]");\n' +
          '    if (!article) return;\n' +
          '    \n' +
          '    const currentId = article.dataset.noteId;\n' +
          '    \n' +
          '    try {\n' +
          '      const res = await fetch("/data/field-notes.index.json", { cache: "no-cache" });\n' +
          '      if (!res.ok) return;\n' +
          '      \n' +
          '      const allNotes = await res.json();\n' +
          '      \n' +
          '      const releasedNotes = allNotes\n' +
          '        .filter(n => n.released === true)\n' +
          '        .sort((a, b) => new Date(a.date) - new Date(b.date));\n' +
          '      \n' +
          '      const currentIndex = releasedNotes.findIndex(n => n.id === currentId);\n' +
          '      if (currentIndex === -1) return;\n' +
          '      \n' +
          '      const nextNote = releasedNotes[currentIndex + 1];\n' +
          '      \n' +
          '      const nextLink = document.getElementById("nextNoteLink");\n' +
          '      const nextTitle = document.getElementById("nextNoteTitle");\n' +
          '      \n' +
          '      if (nextNote && nextLink && nextTitle) {\n' +
          '        nextLink.href = nextNote.href;\n' +
          '        nextTitle.textContent = nextNote.title;\n' +
          '        nextLink.style.display = "flex";\n' +
          '      }\n' +
          '    } catch (err) {\n' +
          '      console.warn("Could not load field notes index for navigation", err);\n' +
          '    }\n' +
          '  }\n' +
          '\n' +
          '  function initFooterYear() {\n' +
          '    const footerYear = document.querySelector("#site-footer #year");\n' +
          '    if (footerYear) footerYear.textContent = new Date().getFullYear();\n' +
          '  }\n' +
          '\n' +
          '  (async function boot() {\n' +
          '    await loadPartial("site-header", "/partials/header.html");\n' +
          '    initHeaderNav();\n' +
          '\n' +
          '    await loadPartial("site-footer", "/partials/footer.html");\n' +
          '    initFooterYear();\n' +
          '    \n' +
          '    await initDynamicNav();\n' +
          '  })();\n' +
          '  </script>\n' +
          '\n' +
          '</body>\n' +
          '</html>';

          // Ensure directory exists
          const dir = 'field-notes/resonance';
          if (!fs.existsSync(dir)) {
            fs.mkdirSync(dir, { recursive: true });
          }
          
          // Write the file
          const filename = process.env.FILENAME || data.filename;
          fs.writeFileSync(dir + '/' + filename, html);
          console.log('Created: ' + dir + '/' + filename);
          ENDSCRIPT
          
          # Check if script succeeded
          if [ $? -ne 0 ]; then
            echo "Node script failed. Log:"
            cat /tmp/generate-html.log
            exit 1
          fi
          cat /tmp/generate-html.log
      
      - name: Update field-notes.index.json
        run: |
          DATA=$(cat /tmp/field-note-data.json)
          TAGS=$(echo "$DATA" | jq -c '.field_note.tags')
          
          # Create new entry
          NEW_ENTRY=$(jq -n \
            --arg id "${{ steps.process.outputs.NOTE_ID }}" \
            --arg title "${{ steps.process.outputs.TITLE }}" \
            --arg subtitle "${{ steps.process.outputs.SUBTITLE }}" \
            --arg date "${{ steps.process.outputs.DATE }}" \
            --arg readTime "${{ steps.process.outputs.READ_TIME }}" \
            --arg excerpt "${{ steps.process.outputs.EXCERPT }}" \
            --arg href "/field-notes/resonance/${{ steps.process.outputs.FILENAME }}" \
            --arg realWorldLink "${{ steps.process.outputs.ORIGINAL_URL }}" \
            --argjson tags "$TAGS" \
            '{
              id: $id,
              category: "resonance",
              title: $title,
              subtitle: $subtitle,
              date: $date,
              readTime: ($readTime | tonumber),
              excerpt: $excerpt,
              featured: true,
              released: true,
              href: $href,
              tags: $tags,
              realWorldLink: $realWorldLink
            }')
          
          # Append to index
          jq --argjson newEntry "$NEW_ENTRY" '. += [$newEntry]' data/field-notes.index.json > /tmp/updated-index.json
          mv /tmp/updated-index.json data/field-notes.index.json
      
      - name: Remove queue file
        run: |
          rm _queue/pending-field-note.json
      
      - name: Commit and push changes
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add .
          git commit -m "Publish field note: ${{ steps.process.outputs.TITLE }}"
          git push
